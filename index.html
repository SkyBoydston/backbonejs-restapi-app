<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Hello World in Backbone.js</title>
</head>
<body>
  <!-- ========= -->
  <!-- Your HTML -->
  <!-- ========= -->

  <h2>Beer app</h2>

  <div id="container">Loading...</div>

  <!-- ========= -->
  <!-- Libraries -->
  <!-- ========= -->
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.3/backbone.js" type="text/javascript"></script>
  <!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone-localstorage.js/1.0/backbone.localStorage-min.js" type="text/javascript"></script>   -->
  
  <!-- =============== -->
  <!-- Javascript code -->
  <!-- =============== -->
  <script type="text/javascript">

    // Backbone.sync = function(method, model) {

    // };
    var BeerCooler = Backbone.Collection.extend({
      model: Beer,

      // urlRoot: 'http://beer.fluentcloud.com/v1/beer'
      url: 'http://beer.fluentcloud.com/v1/beer',

      // parse: function(response) {  // this also isn't being called
      //     alert(response);
      //     return response.beer;
      // }
    });



    var Beer = Backbone.Model.extend({
      // id: null,
      defaults: {
        // "id": null,
        "name": "defaultName",
        "likes": "defaultLikes",
      },
      id: 5,
      initialize: function(){
              console.log('Beer has been intialized');
      },
      // events: 
      // id: function() {
      //   return i++;
      // },
      parse: function (response) {
            console.log('Beer parse called');
            this.set("id", response[0].id);
            this.set("name", response[0].name);
            this.set("likes", response[0].likes);
            // var test = JSON.stringify(response);
            // test = test.replace("[", "");
            // test = test.replace("]", "");
            // test = test.replace("}", "");
            // test = test.replace("{", "");
            // console.log(test);
            // return test;
            return true;
      },
      // initialize: function () {
      //             this.fetch({
      //                success: function() {
      //                    console.log("after init "+this.get("id")+" name="+this.get("name")+" likes="+this.get("likes"));
      //                }.bind(this)
      //             });
      // },

      urlRoot: 'http://beer.fluentcloud.com/v1/beer',
      // url: 'http://beer.fluentcloud.com/v1/beer/5'
      url: function() {
        return this.urlRoot + '/' + this.id++;
      }


    });

    // $.ajaxSetup({
    //     headers: {
    //           'Referer':'test',
    //           'Origin':''
    //       }
    // });
    // beer.fetch({
    //   headers: {
    //                'Content-Type': 'application/json'
    //            },
    //   success: function (model, response, options) {
    //               console.log("Found the beer: ");
    //               // console.log(response.toJSON());
    //               console.log(model);
    //               console.log(response);
    //               console.log(options);
    //               console.log(beer);
    //               console.log(beer.toJSON());
    //               // var appView = new AppView({model: beer});
    //               // beer = beer.toJSON();
    //   },
    //   error: function (model, response, options) {
    //               console.log("problem: " + model + response + options);
    //               console.log(model);
    //               console.log(response);
    //               console.log(options);
    //   }

    // });
    // // beer = beer.toJSON();
    // console.log(beer);

    // beer.on("sync", function() {
    //     console.log(beer.toJSON());
    // });
    // beer.fetch();
    // beer = beer.toJSON();
    // console.log(beer.get('name'));
    // setTimeout(function() {
    //               console.log(beer.get("name"));
    // }, 5000);
    // beer.fetch();

    // var beer1 = new Beer({name: "Bud", likes: 5});
    // var beer2 = new Beer({name: "Corona", likes: 7});
    // var beer3 = new Beer({name: "Beer X", likes: 9});
    // console.log(beer2.name);

    
    // var beerCooler = new BeerCooler;
    // beerCooler.fetch();
    // beerCooler.add([beer1,beer2,beer3]);
    // console.log(beerCooler);
    // console.log(beerCooler.length);
    // beerCooler.bind('reset', function () { console.log(beerCooler); });  // this doesn't seem to get called


    // var beers = new Backbone.Collection({
    //   url: function() {
    //     return 'http://beer.fluentcloud.com/v1/beer';
    //   }
    // });
    // beers.url = 'http://beer.fluentcloud.com/v1/beer';








    // var beers = beers.fetch();
    // console.log(beer1.name);
    // console.log('check');
    // console.log(beers);

    // console.log(beer.attributes.toJSON());
    var AppView = Backbone.View.extend({
      // el - stands for element. Every view has a element associate in with HTML content will be rendered.
      el: '#container',
      // model: Beer,
      my_template: _.template("<strong>Beer name: </strong><%= name %> <br><strong>Number of likes: </strong><%= likes %><br><br>"),
      // It's the first function called when this view it's instantiated.
      initialize: function() {
        // this.listenTo(this.model, "change", this.render);
        this.model.on('change', this.render, this);
        this.model.fetch({
            headers: {
                         'Content-Type': 'application/json'
            }
        });
      },
      // $el - it's a cached jQuery object (el), in which you can use jQuery functions to push content. Like the Hello World in this case.
      render: function() {
        console.log(this.model); 
        this.$el.html(this.my_template(this.model.attributes));
        return this;
      }
      // render: function(){
        
      //     for (var i = 0; i < beerCooler.length; ++i) {
      //       this.$el.append(beerCooler.at(i).get("name"));
      //     }
        
      // }
    });

    // setTimeout(function() {
    //           console.log('boom');
    var beer = new Beer();
              var appView = new AppView({model: beer});
    // }, 3000);
  </script>
  
</body>
</html>